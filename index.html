<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CdeApp Planning - Sistema de Gesti√≥n</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuraci√≥n de Tailwind adicional -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                    }
                }
            }
        }
    </script>
    
    <!-- Script cr√≠tico: INYECTAR base44 INMEDIATAMENTE -->
    <script>
        // ============================================
        // INYECCI√ìN CR√çTICA DE BASE44
        // Esto se ejecuta ANTES de que cargue cualquier cosa
        // ============================================
        console.log('üöÄ Inyectando base44 desde index.html...');
        
        // Crear base44 global de inmediato
        window.base44 = {
            // Authentication
            auth: {
                me: () => {
                    console.log('[Base44 Index] auth.me() llamado');
                    return Promise.resolve({
                        id: 'index-user-' + Date.now(),
                        email: 'admin@cdeapp.com',
                        full_name: 'Administrador del Sistema',
                        role: 'super_admin',
                        avatar_url: null,
                        created_at: new Date().toISOString(),
                        permissions: ['*'],
                        settings: {
                            theme: 'light',
                            language: 'es',
                            notifications: true
                        }
                    });
                },
                
                logout: () => {
                    console.log('[Base44 Index] auth.logout()');
                    return Promise.resolve();
                },
                
                updateMe: (data) => {
                    console.log('[Base44 Index] auth.updateMe()', data);
                    return Promise.resolve({ 
                        success: true, 
                        message: 'Perfil actualizado',
                        data: data 
                    });
                },
                
                login: (credentials) => {
                    console.log('[Base44 Index] auth.login()', credentials);
                    return Promise.resolve({
                        token: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...',
                        user: {
                            id: 'auth-user',
                            email: credentials.email || 'admin@cdeapp.com',
                            full_name: 'Usuario Autenticado'
                        }
                    });
                }
            },
            
            // Entities
            entities: {
                AppConfig: {
                    filter: async (query) => {
                        console.log('[Base44 Index] AppConfig.filter()', query);
                        return [{
                            id: 1,
                            config_key: 'branding',
                            config_value: JSON.stringify({
                                app_name: 'CdeApp Planning',
                                app_subtitle: 'Sistema de Gesti√≥n Integral',
                                logo_url: null,
                                primary_color: '#3b82f6',
                                secondary_color: '#1e40af',
                                company_name: 'Tu Empresa S.A.'
                            }),
                            created_at: '2024-01-01T00:00:00Z'
                        }];
                    }
                },
                
                EmployeeMasterDatabase: {
                    list: async () => {
                        console.log('[Base44 Index] EmployeeMasterDatabase.list()');
                        return [{
                            id: 1,
                            name: 'Usuario Demo',
                            email: 'demo@cdeapp.com',
                            department: 'Administraci√≥n',
                            position: 'Administrador',
                            status: 'active'
                        }];
                    }
                },
                
                MachineMaster: {
                    list: async () => {
                        console.log('[Base44 Index] MachineMaster.list()');
                        return [{
                            id: 1,
                            code: 'M001',
                            name: 'M√°quina Demo',
                            status: 'active',
                            department: 'Producci√≥n'
                        }];
                    }
                },
                
                Process: {
                    list: async () => {
                        console.log('[Base44 Index] Process.list()');
                        return [];
                    }
                },
                
                Assignment: {
                    list: async () => {
                        console.log('[Base44 Index] Assignment.list()');
                        return [];
                    }
                }
            },
            
            // API Methods
            api: {
                get: (url) => {
                    console.log('[Base44 Index] api.get()', url);
                    return Promise.resolve({ data: [], status: 200 });
                },
                
                post: (url, data) => {
                    console.log('[Base44 Index] api.post()', url, data);
                    return Promise.resolve({ 
                        success: true, 
                        data: { id: Date.now(), ...data },
                        status: 201 
                    });
                }
            },
            
            // Debug utilities
            __debug: {
                version: '1.0.0-index',
                injectedVia: 'index.html',
                timestamp: new Date().toISOString(),
                
                test: async () => {
                    console.group('üß™ Test desde index.html');
                    const user = await window.base44.auth.me();
                    console.log('‚úÖ auth.me():', user);
                    console.groupEnd();
                    return user;
                },
                
                reload: () => window.location.reload(),
                
                status: () => ({
                    base44: !!window.base44,
                    React: !!window.React,
                    ReactDOM: !!window.ReactDOM,
                    timestamp: new Date().toISOString()
                })
            }
        };
        
        console.log('‚úÖ base44 inyectado exitosamente desde index.html');
        
        // ============================================
        // DETECTOR DE ERRORES GLOBALES
        // ============================================
        window.addEventListener('error', function(e) {
            console.error('‚ùå ERROR GLOBAL:', e.message, 'en', e.filename, 'l√≠nea', e.lineno);
            
            // Mostrar error amigable si es cr√≠tico
            if (e.message.includes('React') || e.message.includes('base44')) {
                document.getElementById('app').innerHTML = `
                    <div class="p-8 text-center">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Error de Carga</h1>
                        <p class="text-gray-700 mb-4">${e.message}</p>
                        <button onclick="window.location.reload()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Recargar Aplicaci√≥n
                        </button>
                    </div>
                `;
            }
            
            e.preventDefault();
        });
        
        // Capturar errores de promesas no manejadas
        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå PROMESA RECHAZADA:', e.reason);
        });
        
        // ============================================
        // CARGAR REACT SI NO EST√Å DISPONIBLE
        // ============================================
        function cargarReactSiEsNecesario() {
            // Esperar un momento a ver si React se carga autom√°ticamente
            setTimeout(() => {
                if (!window.React || !window.ReactDOM) {
                    console.warn('‚ö†Ô∏è React no detectado, cargando manualmente...');
                    
                    // Cargar React desde CDN
                    const cargarScript = (url, onload) => {
                        const script = document.createElement('script');
                        script.src = url;
                        script.crossOrigin = true;
                        script.onload = onload;
                        document.head.appendChild(script);
                    };
                    
                    cargarScript('https://unpkg.com/react@18/umd/react.development.js', () => {
                        console.log('‚úÖ React cargado manualmente');
                        
                        cargarScript('https://unpkg.com/react-dom@18/umd/react-dom.development.js', () => {
                            console.log('‚úÖ ReactDOM cargado manualmente');
                            verificarYCargarApp();
                        });
                    });
                } else {
                    console.log('‚úÖ React ya est√° disponible');
                    verificarYCargarApp();
                }
            }, 1000);
        }
        
        // ============================================
        // VERIFICAR Y CARGAR LA APLICACI√ìN
        // ============================================
        function verificarYCargarApp() {
            console.log('üîç Verificando requisitos para cargar la app...');
            
            const requisitos = {
                base44: !!window.base44,
                React: !!window.React,
                ReactDOM: !!window.ReactDOM,
                root: !!document.getElementById('app') || !!document.getElementById('root')
            };
            
            console.table(requisitos);
            
            // Si todo est√° listo, intentar cargar la app
            if (requisitos.base44 && requisitos.React && requisitos.ReactDOM) {
                console.log('‚úÖ Todos los requisitos cumplidos');
                
                // Mostrar que se est√° cargando
                const appElement = document.getElementById('app') || document.getElementById('root');
                if (appElement) {
                    appElement.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                            <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent"></div>
                            <h2 class="mt-6 text-2xl font-bold text-gray-800">CdeApp Planning</h2>
                            <p class="mt-2 text-gray-600">Inicializando sistema...</p>
                            <div class="mt-8 space-y-2 text-sm text-gray-500">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                    <span>Base44: Conectado</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                    <span>React: Listo</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-blue-500 animate-pulse mr-2"></div>
                                    <span>Cargando aplicaci√≥n...</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Esperar un momento y luego intentar cargar el main.jsx de Base44
                setTimeout(() => {
                    console.log('üöÄ Intentando cargar la aplicaci√≥n principal...');
                    
                    // Base44 deber√≠a inyectar un script llamado main.[hash].js
                    // Buscarlo y ejecutarlo si existe
                    const base44Script = Array.from(document.scripts).find(s => 
                        s.src && s.src.includes('main.') && s.src.includes('.js')
                    );
                    
                    if (base44Script) {
                        console.log('üì¶ Script principal encontrado:', base44Script.src);
                    } else {
                        console.warn('‚ö†Ô∏è No se encontr√≥ el script principal de Base44');
                        // Intentar cargar manualmente
                        cargarAplicacionManual();
                    }
                }, 2000);
                
            } else {
                console.error('‚ùå Faltan requisitos, cargando aplicaci√≥n manual...');
                cargarAplicacionManual();
            }
        }
        
        // ============================================
        // CARGAR APLICACI√ìN MANUALMENTE (FALLBACK)
        // ============================================
        function cargarAplicacionManual() {
            console.log('üõ†Ô∏è Cargando aplicaci√≥n manualmente...');
            
            const appElement = document.getElementById('app') || document.getElementById('root');
            if (!appElement) {
                console.error('‚ùå No hay elemento para la aplicaci√≥n');
                return;
            }
            
            // Renderizar una app b√°sica con React
            try {
                const { createElement: h } = window.React;
                
                const AppManual = () => h('div', {
                    className: 'min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-8'
                },
                    h('div', {
                        className: 'max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8'
                    },
                        h('h1', {
                            className: 'text-3xl font-bold text-gray-800 mb-6'
                        }, 'üöÄ CdeApp Planning'),
                        
                        h('p', {
                            className: 'text-gray-600 mb-8'
                        }, 'Sistema de Gesti√≥n Integral - Modo de Emergencia'),
                        
                        h('div', {
                            className: 'grid grid-cols-1 md:grid-cols-3 gap-6 mb-8'
                        },
                            h('div', {
                                className: 'bg-blue-50 p-6 rounded-xl'
                            },
                                h('h3', {className: 'font-semibold text-blue-700 mb-2'}, 'Base44 Client'),
                                h('p', {className: 'text-blue-600'}, window.base44 ? '‚úÖ Disponible' : '‚ùå No disponible')
                            ),
                            
                            h('div', {
                                className: 'bg-green-50 p-6 rounded-xl'
                            },
                                h('h3', {className: 'font-semibold text-green-700 mb-2'}, 'React'),
                                h('p', {className: 'text-green-600'}, window.React ? `‚úÖ v${window.React.version}` : '‚ùå No disponible')
                            ),
                            
                            h('div', {
                                className: 'bg-purple-50 p-6 rounded-xl'
                            },
                                h('h3', {className: 'font-semibold text-purple-700 mb-2'}, 'Estado'),
                                h('p', {className: 'text-purple-600'}, 'Modo Emergencia')
                            )
                        ),
                        
                        h('div', {className: 'space-y-4'},
                            h('button', {
                                onClick: () => window.location.reload(),
                                className: 'w-full py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition'
                            }, 'üîÑ Recargar Aplicaci√≥n'),
                            
                            h('button', {
                                onClick: () => window.base44.__debug.test(),
                                className: 'w-full py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition'
                            }, 'üß™ Probar Base44'),
                            
                            h('button', {
                                onClick: () => console.log('Base44:', window.base44, 'React:', window.React),
                                className: 'w-full py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition'
                            }, 'üêõ Mostrar Debug en Consola')
                        )
                    )
                );
                
                window.ReactDOM.render(h(AppManual), appElement);
                console.log('‚úÖ Aplicaci√≥n manual renderizada');
                
            } catch (error) {
                console.error('‚ùå Error renderizando app manual:', error);
                appElement.innerHTML = `
                    <div class="p-8 text-center">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">Error Cr√≠tico</h1>
                        <p class="text-gray-700 mb-4">${error.message}</p>
                        <button onclick="window.location.reload()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            Reiniciar Aplicaci√≥n
                        </button>
                    </div>
                `;
            }
        }
        
        // ============================================
        // INICIAR EL PROCESO DE CARGA
        // ============================================
        console.log('‚è≥ Iniciando proceso de carga...');
        
        // Esperar a que el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM completamente cargado');
                cargarReactSiEsNecesario();
            });
        } else {
            console.log('üìÑ DOM ya est√° listo');
            cargarReactSiEsNecesario();
        }
        
    </script>
    
    <!-- Estilos adicionales -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Contenedor principal -->
    <div id="app" class="min-h-screen">
        <!-- Estado de carga inicial -->
        <div class="flex flex-col items-center justify-center h-screen bg-gradient-to-br from-blue-50 to-indigo-100 fade-in">
            <div class="text-center p-8 max-w-md">
                <div class="animate-spin rounded-full h-20 w-20 border-4 border-blue-500 border-t-transparent mx-auto mb-6"></div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">CdeApp Planning</h1>
                <p class="text-gray-600 mb-6">Sistema de Gesti√≥n Integral</p>
                
                <div class="space-y-3 text-left bg-white/50 backdrop-blur-sm rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-700">Inyectando Base44...</span>
                        <div id="status-base44" class="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-700">Cargando React...</span>
                        <div id="status-react" class="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-700">Iniciando aplicaci√≥n...</span>
                        <div id="status-app" class="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>
                    </div>
                </div>
                
                <p class="mt-8 text-sm text-gray-500 loading-dots">Cargando sistema</p>
            </div>
        </div>
    </div>
    
    <!-- Script para actualizar estados visualmente -->
    <script>
        // Actualizar indicadores visuales
        function actualizarEstado(elementoId, estado) {
            const elemento = document.getElementById(elementoId);
            if (elemento) {
                elemento.className = 'w-3 h-3 rounded-full ' + (
                    estado === 'success' ? 'bg-green-500' :
                    estado === 'loading' ? 'bg-blue-500 animate-pulse' :
                    'bg-red-500'
                );
            }
        }
        
        // Actualizar estados
        setTimeout(() => actualizarEstado('status-base44', 'success'), 500);
        setTimeout(() => actualizarEstado('status-react', 'success'), 1500);
        setTimeout(() => actualizarEstado('status-app', 'loading'), 2500);
    </script>
</body>
</html>
